%YAML 1.2
---
name: Claude Output
scope: text.claude
file_extensions: []
hidden: true

contexts:
  main:
    # Prompt starts with ◎ and ends with ▶
    - match: '^◎ '
      scope: claude.prompt.marker punctuation.definition.prompt.begin
      push: prompt

  prompt:
    # Prompt text until closing ▶
    - meta_scope: claude.prompt entity.name.section
    - match: ' ▶$'
      scope: claude.prompt.marker punctuation.definition.prompt.end
      set: conversation

  conversation:
    # Next prompt ends this section (pop BEFORE matching the new prompt)
    - match: '(?=^◎ )'
      pop: true

    # Done tag ends the conversation
    - match: '^\s*@done\([^)]+\)$'
      scope: claude.meta.done comment.line
      pop: true

    # Tool pending
    - match: '^\s*☐ .+$'
      scope: claude.tool.pending

    # Tool done
    - match: '^\s*✔ .+$'
      scope: claude.tool.done

    # Tool error
    - match: '^\s*✘ .+$'
      scope: claude.tool.error

    # Interrupted marker
    - match: '\*\[interrupted\]\*'
      scope: claude.interrupted

    # Tool output lines (│ prefix)
    - match: '^\s*│ .+$'
      scope: claude.tool.output

    # Tool result arrow (→)
    - match: ' → \d+ (files|matches).*$'
      scope: claude.tool.result

    # Permission request
    - match: '^\s*(⚠)\s*(Allow)\s+(\w+)'
      captures:
        1: claude.permission.icon markup.warning
        2: claude.permission.label
        3: claude.permission.tool entity.name.function

    # Permission buttons
    - match: '\[Y\] Allow'
      scope: claude.permission.button.allow
    - match: '\[N\] Deny'
      scope: claude.permission.button.deny
    - match: '\[A\] Allow all \w+'
      scope: claude.permission.button.allowall

    # Fenced code blocks with language embedding
    - match: '^(\s*)(```)(python|py)\s*$'
      captures:
        2: punctuation.definition.code.begin.markdown
        3: constant.other.language-name.markdown
      embed: scope:source.python
      embed_scope: markup.raw.block.markdown source.python.embedded
      escape: ^\1```\s*$
      escape_captures:
        0: punctuation.definition.code.end.markdown

    - match: '^(\s*)(```)(nim)\s*$'
      captures:
        2: punctuation.definition.code.begin.markdown
        3: constant.other.language-name.markdown
      embed: scope:source.nim
      embed_scope: markup.raw.block.markdown source.nim.embedded
      escape: ^\1```\s*$
      escape_captures:
        0: punctuation.definition.code.end.markdown

    - match: '^(\s*)(```)(js|javascript)\s*$'
      captures:
        2: punctuation.definition.code.begin.markdown
        3: constant.other.language-name.markdown
      embed: scope:source.js
      embed_scope: markup.raw.block.markdown source.js.embedded
      escape: ^\1```\s*$
      escape_captures:
        0: punctuation.definition.code.end.markdown

    - match: '^(\s*)(```)(ts|typescript)\s*$'
      captures:
        2: punctuation.definition.code.begin.markdown
        3: constant.other.language-name.markdown
      embed: scope:source.ts
      embed_scope: markup.raw.block.markdown source.ts.embedded
      escape: ^\1```\s*$
      escape_captures:
        0: punctuation.definition.code.end.markdown

    - match: '^(\s*)(```)(json)\s*$'
      captures:
        2: punctuation.definition.code.begin.markdown
        3: constant.other.language-name.markdown
      embed: scope:source.json
      embed_scope: markup.raw.block.markdown source.json.embedded
      escape: ^\1```\s*$
      escape_captures:
        0: punctuation.definition.code.end.markdown

    - match: '^(\s*)(```)(sh|bash|shell)\s*$'
      captures:
        2: punctuation.definition.code.begin.markdown
        3: constant.other.language-name.markdown
      embed: scope:source.shell.bash
      embed_scope: markup.raw.block.markdown source.shell.embedded
      escape: ^\1```\s*$
      escape_captures:
        0: punctuation.definition.code.end.markdown

    - match: '^(\s*)(```)(rust|rs)\s*$'
      captures:
        2: punctuation.definition.code.begin.markdown
        3: constant.other.language-name.markdown
      embed: scope:source.rust
      embed_scope: markup.raw.block.markdown source.rust.embedded
      escape: ^\1```\s*$
      escape_captures:
        0: punctuation.definition.code.end.markdown

    - match: '^(\s*)(```)(go|golang)\s*$'
      captures:
        2: punctuation.definition.code.begin.markdown
        3: constant.other.language-name.markdown
      embed: scope:source.go
      embed_scope: markup.raw.block.markdown source.go.embedded
      escape: ^\1```\s*$
      escape_captures:
        0: punctuation.definition.code.end.markdown

    - match: '^(\s*)(```)(c)\s*$'
      captures:
        2: punctuation.definition.code.begin.markdown
        3: constant.other.language-name.markdown
      embed: scope:source.c
      embed_scope: markup.raw.block.markdown source.c.embedded
      escape: ^\1```\s*$
      escape_captures:
        0: punctuation.definition.code.end.markdown

    - match: '^(\s*)(```)(cpp|c\+\+)\s*$'
      captures:
        2: punctuation.definition.code.begin.markdown
        3: constant.other.language-name.markdown
      embed: scope:source.c++
      embed_scope: markup.raw.block.markdown source.c++.embedded
      escape: ^\1```\s*$
      escape_captures:
        0: punctuation.definition.code.end.markdown

    - match: '^(\s*)(```)(yaml|yml)\s*$'
      captures:
        2: punctuation.definition.code.begin.markdown
        3: constant.other.language-name.markdown
      embed: scope:source.yaml
      embed_scope: markup.raw.block.markdown source.yaml.embedded
      escape: ^\1```\s*$
      escape_captures:
        0: punctuation.definition.code.end.markdown

    - match: '^(\s*)(```)(html)\s*$'
      captures:
        2: punctuation.definition.code.begin.markdown
        3: constant.other.language-name.markdown
      embed: scope:text.html.basic
      embed_scope: markup.raw.block.markdown text.html.embedded
      escape: ^\1```\s*$
      escape_captures:
        0: punctuation.definition.code.end.markdown

    - match: '^(\s*)(```)(css)\s*$'
      captures:
        2: punctuation.definition.code.begin.markdown
        3: constant.other.language-name.markdown
      embed: scope:source.css
      embed_scope: markup.raw.block.markdown source.css.embedded
      escape: ^\1```\s*$
      escape_captures:
        0: punctuation.definition.code.end.markdown

    - match: '^(\s*)(```)(sql)\s*$'
      captures:
        2: punctuation.definition.code.begin.markdown
        3: constant.other.language-name.markdown
      embed: scope:source.sql
      embed_scope: markup.raw.block.markdown source.sql.embedded
      escape: ^\1```\s*$
      escape_captures:
        0: punctuation.definition.code.end.markdown

    - match: '^(\s*)(```)(ruby|rb)\s*$'
      captures:
        2: punctuation.definition.code.begin.markdown
        3: constant.other.language-name.markdown
      embed: scope:source.ruby
      embed_scope: markup.raw.block.markdown source.ruby.embedded
      escape: ^\1```\s*$
      escape_captures:
        0: punctuation.definition.code.end.markdown

    - match: '^(\s*)(```)(lua)\s*$'
      captures:
        2: punctuation.definition.code.begin.markdown
        3: constant.other.language-name.markdown
      embed: scope:source.lua
      embed_scope: markup.raw.block.markdown source.lua.embedded
      escape: ^\1```\s*$
      escape_captures:
        0: punctuation.definition.code.end.markdown

    - match: '^(\s*)(```)(diff)\s*$'
      captures:
        2: punctuation.definition.code.begin.markdown
        3: constant.other.language-name.markdown
      embed: scope:source.diff
      embed_scope: markup.raw.block.markdown source.diff.embedded
      escape: ^\1```\s*$
      escape_captures:
        0: punctuation.definition.code.end.markdown

    - match: '^(\s*)(```)(xml)\s*$'
      captures:
        2: punctuation.definition.code.begin.markdown
        3: constant.other.language-name.markdown
      embed: scope:text.xml
      embed_scope: markup.raw.block.markdown text.xml.embedded
      escape: ^\1```\s*$
      escape_captures:
        0: punctuation.definition.code.end.markdown

    # Generic fenced block (no language or unknown)
    - match: '^(\s*)(```)(\w*)\s*$'
      captures:
        2: punctuation.definition.code.begin.markdown
        3: constant.other.language-name.markdown
      push: generic_code_block

    # Markdown: Headings
    - match: '^(#{1,6})\s+(.+)$'
      captures:
        1: punctuation.definition.heading.markdown
        2: markup.heading.markdown entity.name.section.markdown

    # Markdown: Bold **text** or __text__
    - match: '(\*\*|__)(.+?)(\1)'
      captures:
        1: punctuation.definition.bold.begin.markdown
        2: markup.bold.markdown
        3: punctuation.definition.bold.end.markdown

    # Markdown: Italic *text* or _text_
    - match: '(?<!\*)(\*|_)(?!\s)(.+?)(?<!\s)(\1)(?!\*)'
      captures:
        1: punctuation.definition.italic.begin.markdown
        2: markup.italic.markdown
        3: punctuation.definition.italic.end.markdown

    # Markdown: Inline code `code`
    - match: '(`+)([^`]+)(\1)'
      captures:
        1: punctuation.definition.raw.begin.markdown
        2: markup.raw.inline.markdown
        3: punctuation.definition.raw.end.markdown

    # Markdown: Links [text](url)
    - match: '(\[)([^\]]+)(\])(\()([^\)]+)(\))'
      captures:
        1: punctuation.definition.link.begin.markdown
        2: markup.underline.link.markdown string.other.link.title.markdown
        3: punctuation.definition.link.end.markdown
        4: punctuation.definition.metadata.begin.markdown
        5: markup.underline.link.markdown
        6: punctuation.definition.metadata.end.markdown

    # Markdown: Unordered list items
    - match: '^\s*([-*+])\s+'
      captures:
        1: punctuation.definition.list_item.markdown markup.list.unnumbered.markdown

    # Markdown: Ordered list items
    - match: '^\s*(\d+\.)\s+'
      captures:
        1: punctuation.definition.list_item.markdown markup.list.numbered.markdown

    # Markdown: Blockquote
    - match: '^\s*(>)\s*'
      captures:
        1: punctuation.definition.blockquote.markdown
      push: blockquote

    # Markdown: Horizontal rule
    - match: '^\s*([-*_]){3,}\s*$'
      scope: punctuation.definition.thematic-break.markdown

    # Everything else is response text
    - match: '.'
      scope: claude.text

  blockquote:
    - meta_scope: markup.quote.markdown
    - match: '$'
      pop: true

  generic_code_block:
    - meta_scope: markup.raw.block.markdown
    - match: '^\s*```\s*$'
      scope: punctuation.definition.code.end.markdown
      pop: true
